<%# coding: UTF-8 %>


<% require 'rubygems' %>
<% require 'erb' %>
<% require './data_model.rb'%>
<% require './my_ruby_library/weather.rb' %>
<% require './my_ruby_library/login_data.rb' %>
<% require './total_learning_time.rb'%>


<% weather = weather() %>



<% total_time = total_learning_time() %>


<% login_user = LoginUser.new %>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>mimalb studylog</title>
  <link rel="shortcut icon" href="images/icon.png" type="image/png">

  <!-- BootStrapの読み込み -->
  <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.22/themes/base/jquery-ui.css" type="text/css" />

  <!-- DateTimePickerの読み込み -->
  <link href="css/datetimepicker/jquery.datetimepicker.css" rel="stylesheet" type="text/css" >

  <!-- my_cssの読み込み -->
  <link href="css/my_css.css" rel="stylesheet" type="text/css" >

</head>
<body>


  <!-- ナビゲーション -->
  <nav class="navbar navbar-default" role="navigation">
    <div class="container">

        <!-- ナビゲーションヘッダー -->
        <div class="navbar-header">

          <!-- スマホサイズになった時のボタンの設定 -->
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand text-info" href="index.erb"></a>

        </div>

        <!-- ナビゲーションの内容 -->
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.erb">ホーム</a></li>
            <li><a href="personal.erb">学習データ</a></li>
            <li><a href="personal.erb">みんなの活動</a></li>
          </ul>
        </div>

    </div>
  </nav>

  <!-- メインコンテンツ  -->
  <div class="container" style="padding: 20px 0">

    <!-- グリッドシステムを使用する -->
    <div class="row">

      <!-- ログイン情報 -->
      <div class="col-sm-2">
        <div class="panel panel-default">
          <table class="table table-bordered">
            <thead>
              <tr><th class="text-center">ログイン情報</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>


<% user = User.find( login_user.get_userid() ) %>

                  <img src="images/<%= "#{user.image_name}" %>" alt="ユーザ画像" width="130" height="130" class="img-thumbnail img-responsive center-block" style="margin-top:8pt;">
                  <h4 class="text-center"><a><%= "#{user.user_name.to_s}".force_encoding("utf-8") %></a></h4>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ユーザ情報 -->
        <div class="row">
          <div class="col-sm-12">
            <div class="panel panel-default">
              <table class="table table-bordered">
                <thead>
                  <tr><th class="text-center">ユーザの情報</th></tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <h5>連続ログイン　<strong>4日目</strong></h5>
                      <h5>ランキング　　<strong>第2位</strong></h5>
                      <h5>合計学習時間　<strong>380時間</strong></h5>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- お天気情報 -->
          <div class="col-sm-12">
            <div class="panel panel-default">
              <table class="table table-bordered">
                <thead>
                  <tr><th class="text-center"><%= "#{weather['city']}" %>の天気</th></tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="text-center">
                        <h4 class="tec"><%= "#{weather['telop']}" %></h4>
                        <img src="<%= "#{weather['icon']}" %>" class="img-responsive center-block" >
                        <span><%= "#{weather['max_celsius']}" %></span> / <span><%= "#{weather['min_celsius']}" %></span>℃
                      </div>
                    </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>

      </div>

      <div class="col-sm-6">

        <!-- 学習時間ランキング -->
        <div class="panel panel-default">
          <table class="table table-bordered">
            <thead>
              <tr><th class="text-center">今日の学習時間ランキング</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div style="float:left; margin-top: 50px;">
                    <ul style="list-style:none;">

<% total_sort = total_time.sort_by{|key,val| -val} %>
<% image_number = 1%>
<% total_sort.first(3).each {|key, value| %>

                      <li style="font-size:20px; font-weight:bold;"><img src="images/rank<%= "#{image_number}" %>.png" style="width:50px; margin:5px;"><%= "#{key}".force_encoding("utf-8") %> <%= "#{value}".force_encoding("utf-8") %>分</li>

<%  image_number = image_number + 1 %>
<% } %>

                    </ul>
                  </div>
                    <!-- みんなの学習時間のバブルチャート -->
                    <div style="float:left;">
                      <div id="myGraph"></div>
                    </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 学習の記録フォーム　アクションはlog -->
        <div class="row">
          <div class="col-sm-12">
            <form method="post" action="log">
              <div class="panel panel-default">
                <table class="table table-bordered">
                  <thead>
                    <tr><th><span id="date"></span>の勉強を記録する</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="form-group">

                           <!-- タスク名の入力 -->
                          <p style="margin: 15px 10px;" >
                            <label for="task_name">タスク名</label>
                            <input style="width:40%; min-width:250px;" type="text" class="form-control" name="task_name">
                          </p>

                          <!-- 一人かグループかの選択 -->
                          <p style="margin: 15px 10px;">
                            <label for="group_frag">一人 or グループでの学習</label>
                            <select style="width:40%; min-width:250px;"class="form-control"  name="group_frag">

                              <option value="0">個人での学習</option>
                              <option value="1">グループでの学習</option>

                            </select>
                          </p>

                          <!-- 音楽ありなしかの選択 -->
                          <p style="margin: 15px 10px;">
                            <label for="group_frag">音楽の有無</label>
                            <select style="width:40%; min-width:250px;"class="form-control"  name="music_frag">

                              <option value="0">音楽なし</option>
                              <option value="1">音楽あり</option>

                            </select>
                          </p>

                          <!-- 作業時間の入力 -->
                          <p style="margin: 15px 10px;" >
                            <label for="start_time">作業した時間を入力</label>
                            <div class="form-inline" style="margin:0px 0px 0px 10px;">
                              <label>開始時間</label>
                              <input id="datetimepicker_start" class="form-control" type="text" name="start_time" />
                              <label>から</label>
                              <input id="datetimepicker_finish" class="form-control" type="text" name="finish_time" />
                              <label>まで</label>
                            </div>
                          </p>


                          <!-- コメントの入力 -->
                          <p style="margin: 15px 10px;" >
                            <label for="comment">学習内容や感想など</label>
                            <textarea name="comment" class="form-control" row="2" placeholder="学習内容や感想" style="resize: none;"></textarea>
                            <p class="help-block" style="margin-left: 10px;">※できるだけ他の人もわかるように書きましょう。</p>
                          </p>

                          <p style="margin: 15px 10px;">
                            <button type="submit" class="btn btn-success">記録する</button>
                          </p>

                        </div>

                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </form>
          </div>
        </div>

      </div>

      <!-- タイムライン表示 -->
      <div class="col-sm-4">
        <div class="panel panel-default">
          <table class="table table-bordered scrollTable">
            <thead>
              <tr><th class="text-center">タイムライン</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <ul class="media-list" >
                    <hr>


<% task = Task.all.order("task_id desc").limit(100)%>
<% task.each do |row| %>
<%  image_name = User.find_by(user_id: row.user_id ) %>


                      <li class="media">
                        <!-- pull-right にすると、画像が右端に表示される -->
                        <a class="media-left" href="#">
                          <img class="media-object" src="images/<%= "#{image_name.image_name}" %>" alt="写真" width="70" height="70" class="img-responsive" >
                        </a>
                        <div class="media-body">
                          <h4 class="media-heading"> <%= "#{image_name.user_name}".force_encoding("utf-8") %> </h4>
                          <%= "#{row.comment}".force_encoding("utf-8") %>
                        </div>
                      </li>
                      <hr>

<% end %>

                  </ul>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- footer -->
  <footer class="footer" style="height: 40px; background-color: #f5f5f5;">
    <div class="container" >
      <p class="text-muted" style="padding: 5px;">Copyright (C) 2015 Takuma Sasaki ALL Right Reserved.</p>
    </div>
  </footer>


  <!-- javascriptの読み込み -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.22/jquery-ui.min.js"></script>
  <script src="js/bootstrap/bootstrap.min.js"></script>

  <!-- ライブラリ -->
  <script src="js/datetimepicker/jquery.datetimepicker.js"></script>
  <script src="js/Chart/Chart.js"></script>
  <script src="http://momentjs.com/downloads/moment.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="js/scrolltable/jquery.scrolltable.js"></script>


  <!-- 自分で書いたスクリプト -->
  <script src="js/my_library/current_time.js"></script>

  <script>

  // みんなの学習時間をバブルチャートとして表示する処理
  var list = {
      "name": "長野県",
      "children": [
          {
              "name": "塩尻市",
              "children": [

<% #みんなの合計学習時間の表示  %>
<% total_time.each{|key,value| %>
                  { "name": "<%= "#{key}".force_encoding("utf-8") %>" , "households": <%= value %> + 10 },
<% } %>
                 
              ]
          }
      ]
  };
  var svgWidth = 300; // SVG領域の横幅
  var svgHeight = 250;    // SVG領域の縦幅
  var diameter = 250; // 一番大きい円のサイズ
  var color = ["none", "#ffa0a0", "#a0a0ff", "orange", "#ffe090", "#a0ff90", "cyan", "#ccc", "#ff8080", "#c0ffc0", "#4090ff"];
  var svg = d3.select("#myGraph").append("svg")
      .attr("width", svgWidth).attr("height", svgHeight)
  var bubble = d3.layout.pack()
      .size([diameter, diameter]) // 表示サイズを指定
  var grp = svg.selectAll("g")    // グループを対象にする
      .data(bubble.nodes(classes(list)))  // データを読み込む
      .enter()
      .append("g")
      .attr("transform", function(d) {    // 円のX,Y座標を設定
          return "translate(" + d.x + "," + d.y + ")";
      })
  grp.append("circle")    // 円を生成する
      .attr("r", function(d){ // 円を指定した半径にする
          return d.r;
      })
      .attr("fill", function(d,i){    // 塗りの色を指定
          return color[i];
      })
  grp.append("text")  // 文字を生成する
      .attr("font-size", "10pt")   // 文字のサイズを指定する
      .attr("fill", "black")  // 文字の塗りの色を指定する
      .style("text-anchor", "middle") // 円の座標の中央から表示するようにする
      .text(function(d) { return d.className; } ) // データの中のclassNameが地区名なので、それを出力
  // 階層化されたJSONデータをフラット化する (D3.js本家のを少し変更して利用)
  function classes(root) {
      var classes = [];
      function recurse(name, node) {
          if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
              else classes.push({packageName: name, className: node.name, value: node.households});
      }
      recurse(null, root);
      return {children: classes};
  }


  // 現在の日付を取得
  var m = moment();
  var date = m.format("YYYY年MM月DD日");


  $(function (){

    // テーブルにスクロールバーを付ける処理
    $('.scrollTable').scrolltable({
      maxHeight: 500
    });


    // 現在の日付を表示するメソッド
    current_time(date);

    // 開始時間のUIの設定
    $('#datetimepicker_start').datetimepicker({
        format: 'Y-m-d H:i',
        lang: 'ja'
    });

    // 終了時間のUIの設定
    $('#datetimepicker_finish').datetimepicker({
        format: 'Y-m-d H:i',
        lang: 'ja'
    });

  });

  </script>
</body>
</html>
